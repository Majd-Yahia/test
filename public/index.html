<!DOCTYPE html>
<html>
  <head>
    <title>Ping Pong Game</title>
  </head>
  <body>
    <canvas
      id="canvas"
      width="800"
      height="400"
      style="border: 1px solid #d3d3d3"
    ></canvas>
    <script type="text/javascript" src="js/app.js"></script>
    <script type="module" type="text/javascript">
      //Sample functions, remove these functions and design ping-pong game with onInit and onUpdate.

      import { PlayersLogic } from "./js/player.js";

      app.onInit = function () {
        const app = this;

        // Add margin safety for canvas.
        let safetyMargin = 30;

        // Add canvas width, height - safety
        document.getElementById("canvas").width =
          window.innerWidth - safetyMargin;
        document.getElementById("canvas").height =
          window.innerHeight - safetyMargin;

        // Set the width and height of canvas in render.
        this.width = window.innerWidth - safetyMargin;
        this.height = window.innerHeight - safetyMargin;

        this.nodes.push({
          id: "racketOne",
          x: 20,
          y: app.height / 2,
          width: 10,
          height: 50,
          color: "black",
          direction: 0,
          speed: 4,
        });

        this.nodes.push({
          id: "racketTwo",
          x: app.width - 20,
          y: app.height / 2,
          width: 10,
          height: 50,
          color: "black",
          direction: 0,
          speed: 4,
        });

        this.nodes.push({
          id: "ball",
          x: app.width / 2,
          y: app.height / 2,
          width: 10,
          height: 10,
          radius: 5,
          color: "black",
          directionX: 1,
          directionY: -0.8,
          speed: 4,
        });

        this.nodes.push({
          id: "gameState",
          defaultBallSpeed: 3,
          playerOneScore: 0,
          playerTwoScore: 0,
          maxScore: 3,
          paused: true,
          end: false,
          reset: false,
          maxBallSpeed: 9,
        });

        this.nodes.push({
          id: "score",
          text: "0 - 0",
          x: 10,
          y: app.height - 20,
        });
      };

      app.onUpdate = function (time) {
        // Caching some variables for ease of access.
        let playerOne = this.getNode("racketOne"); // Cache the playerOne.
        let playerTwo = this.getNode("racketTwo"); // Cache the playerTwo.
        let ball = this.getNode("ball"); // Cache the ball.
        let gameState = this.getNode("gameState");
        let scoreText = this.getNode("score");

        function RestGame() {
          if (
            gameState == undefined ||
            playerOne == undefined ||
            playerTwo == undefined ||
            ball == undefined ||
            scoreText == undefined
          ) {
            console.log("RestGame: Undefined variable detected!");
            return;
          }

          gameState.reset = true;

          // Reset players position.
          playerOne.y = app.height / 2;
          playerTwo.y = app.height / 2;

          // Reset ball position.
          ball.speed = 0;
          ball.x = app.width / 2;
          ball.y = app.height / 2;

          ball.directionX = RandomBallXDirection();
          ball.directionY = RandomBallYDirection();
          ball.speed = gameState.defaultBallSpeed;

          scoreText.text =
            gameState.playerOneScore + " - " + gameState.playerTwoScore;
        }

        function GameWon() {
          if (gameState == undefined) {
            console.log("GameWon: Game state is undefined");
            return;
          }

          if (!gameState.end) {
            if (
              gameState.playerOneScore === gameState.maxScore &&
              gameState.maxScore != undefined
            ) {
              scoreText.text =
                "Player One has won the game! - Press space to restart";
              gameState.end = true;
            } else if (
              gameState.playerTwoScore === gameState.maxScore &&
              gameState.maxScore != undefined
            ) {
              scoreText.text =
                "Player Two has won the game! - Press space to restart";
              gameState.end = true;
            }
          }
        }

        function RandomBallXDirection() {
          return Math.random(1) < 0.5 ? -1 : 1;
        }
        function RandomBallYDirection() {
          return Math.random(1) + 0.2;
        }

        function Continue() {
          if (gameState == undefined) {
            console.log("Continue: Game state is undefined");
            return;
          }

          if (playerOne == undefined || playerTwo == undefined) {
            console.log("Continue: Player is undefined.");
            return;
          }

          // if game is paused or is resetting or endded don't move anything.
          if (gameState.paused || gameState.reset || gameState.end) {
            return;
          }
        }

        PlayersLogic(playerOne, playerTwo);
      };
    </script>
  </body>
</html>
